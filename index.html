<div id="debug-log" style="background:#000; color:#0f0; font-family:monospace; padding:10px; height:100px; overflow-y:scroll; font-size:11px; margin-bottom:10px; border:1px solid #333; border-radius:4px; line-height:1.4;">
    [SYSTEM READY] - Targeting Session Info for Location...
</div>

<div style="background:#1a1a1a; padding:15px; border:1px solid #333; color:#ff6600; font-family:Consolas, monospace; border-radius:4px;">
    <input type="text" id="pName" placeholder="RSI Handle" style="width:100%; margin-bottom:10px; background:#222; color:#fff; border:1px solid #444; padding:8px;">
    <input type="text" id="gCode" placeholder="Group Code (e.g. SQUAD1)" style="width:100%; margin-bottom:10px; background:#222; color:#fff; border:1px solid #444; padding:8px;">
    <input type="text" id="gUrl" placeholder="Google Script URL" style="width:100%; margin-bottom:15px; background:#222; color:#fff; border:1px solid #444; padding:8px;">
    
    <button id="finalStartBtn" style="width:100%; background:#ff6600; color:#000; font-weight:bold; padding:12px; border:none; cursor:pointer; font-family:Consolas, monospace; text-transform:uppercase;">
        START MONITORING
    </button>
</div>

<div id="squad-list-container" style="margin-top:20px; color:#ff6600; font-family:Consolas, monospace; background:#111; border:1px solid #333; padding:15px; display:none; border-radius:4px;">
    <h3 style="margin:0 0 15px 0; font-size:16px; border-bottom:1px solid #333; color:#00ffee; padding-bottom:5px;">ðŸ“¡ SQUAD STATUS (FILTERED)</h3>
    <table style="width:100%; border-collapse: collapse; text-align: left; color:#fff;">
        <thead>
            <tr style="font-size:12px; color:#888; text-transform:uppercase; border-bottom:1px solid #222;">
                <th style="padding:10px;">Handle</th>
                <th style="padding:10px;">Location</th>
                <th style="padding:10px;">Status</th>
            </tr>
        </thead>
        <tbody id="squad-table-body"></tbody>
    </table>
</div>

<video id="video" autoplay playsinline style="display:none;"></video>
<canvas id="monitor-canvas" style="display:none;"></canvas>

<script>
(function() {
    const tesseractScript = document.createElement('script');
    tesseractScript.src = "https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js";
    document.head.appendChild(tesseractScript);

    let lastStatus = "ALIVE";
    let lastLoc = "UNKNOWN";
    let respawnStartTime = 0;
    const COOLDOWN = 30000;

    function log(msg) {
        const d = document.getElementById('debug-log');
        if (d) { d.innerHTML += "<br>> " + msg; d.scrollTop = d.scrollHeight; }
    }

    tesseractScript.onload = () => {
        log("OCR Ready. Ensure r_DisplaySessionInfo 1 is active.");
        document.getElementById('finalStartBtn').addEventListener('click', init);
    };

    async function scanScreen() {
        const video = document.getElementById('video');
        const canvas = document.getElementById('monitor-canvas');
        if (!video || video.readyState !== 4) return;

        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        let currentStatus = "ALIVE";

        // 1. FAST PIXEL CHECK (Center Darkness)
        const frame = ctx.getImageData(canvas.width/2 - 10, canvas.height/2 - 10, 20, 20);
        let dark = 0;
        for (let i = 0; i < frame.data.length; i += 4) {
            if (frame.data[i] < 20 && frame.data[i+1] < 20 && frame.data[i+2] < 20) dark++;
        }

        if (dark > 350) {
            currentStatus = "RESPAWNING";
            respawnStartTime = Date.now();
        } else {
            // 2. INCAP OCR (Bottom Center)
            const incapC = document.createElement('canvas');
            incapC.width = canvas.width; incapC.height = canvas.height/4;
            incapC.getContext('2d').drawImage(canvas, 0, canvas.height*0.75, canvas.width, canvas.height/4, 0, 0, canvas.width, canvas.height/4);
            try {
                const { data: { text } } = await Tesseract.recognize(incapC, 'eng');
                if (text.toLowerCase().includes("incapacitated")) currentStatus = "INCAP";
            } catch(e) {}

            // 3. TARGETED LOCATION OCR (Upper Right Block)
            const infoW = Math.floor(canvas.width * 0.45);
            const infoH = Math.floor(canvas.height * 0.40);
            const locC = document.createElement('canvas');
            locC.width = infoW; locC.height = infoH;
            const lCtx = locC.getContext('2d');
            lCtx.drawImage(canvas, canvas.width - infoW, 0, infoW, infoH, 0, 0, infoW, infoH);

            // CONTRAST FILTER FOR WHITE TEXT
            let imgData = lCtx.getImageData(0, 0, infoW, infoH);
            for (let i = 0; i < imgData.data.length; i += 4) {
                let b = (imgData.data[i] + imgData.data[i+1] + imgData.data[i+2]) / 3;
                let v = b > 180 ? 255 : 0; 
                imgData.data[i] = imgData.data[i+1] = imgData.data[i+2] = v;
            }
            lCtx.putImageData(imgData, 0, 0);

            try {
                const { data: { text: zText } } = await Tesseract.recognize(locC, 'eng');
                // Target specifically "Current player location :"
                const match = zText.match(/location\s*[:;]\s*([^(\n]+)/i);
                if(match) {
                    lastLoc = match[1].trim();
                    log("Detected: " + lastLoc); 
                }
            } catch(e) {}
        }

        if (currentStatus === "ALIVE" && (Date.now() - respawnStartTime < COOLDOWN)) {
            currentStatus = "RESPAWNING";
        }

        // SYNC TO BACKEND
        const gUrl = document.getElementById('gUrl').value;
        const pName = document.getElementById('pName').value;
        const gCode = document.getElementById('gCode').value.toUpperCase();
        
        if (gUrl && pName) {
            fetch(gUrl, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ 
                    player_name: pName, 
                    status: currentStatus, 
                    group_code: gCode, 
                    location: lastLoc 
                })
            });
            if(currentStatus !== lastStatus) log("Status: " + currentStatus);
            lastStatus = currentStatus;
        }
    }

    async function refreshSquad() {
        const gUrl = document.getElementById('gUrl').value;
        const gCode = document.getElementById('gCode').value.toUpperCase();
        if (!gUrl || !gCode) return;
        try {
            const res = await fetch(`${gUrl}?group=${gCode}`);
            const data = await res.json();
            const tbody = document.getElementById('squad-table-body');
            
            tbody.innerHTML = Object.entries(data).map(([n, val]) => {
                const parts = val.split('|');
                const st = parts[0].trim();
                const lc = parts[1] || "UNKNOWN";
                const color = st === 'INCAP' ? '#ff4444' : st === 'RESPAWNING' ? '#ffff00' : '#44ff44';
                return `<tr style="color:${color}; border-bottom:1px solid #222;">
                    <td style="padding:10px;">${n}</td>
                    <td style="padding:10px; color:#aaa; font-weight:normal;">${lc}</td>
                    <td style="padding:10px; font-weight:bold;">${st}</td>
                </tr>`;
            }).join('');
        } catch(e) {}
    }

    async function init() {
        try {
            const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            document.getElementById('video').srcObject = stream;
            document.getElementById('squad-list-container').style.display = "block";
            log("MONITORING ACTIVE.");
            setInterval(scanScreen, 4000);
            setInterval(refreshSquad, 4000);
            document.getElementById('finalStartBtn').disabled = true;
            document.getElementById('finalStartBtn').style.background = "#333";
        } catch (err) { log("Error: " + err.message); }
    }
})();
</script>
