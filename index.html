<div id="debug-log" style="background:#000; color:#0f0; font-family:monospace; padding:10px; height:100px; overflow-y:scroll; font-size:11px; margin-bottom:10px; border:1px solid #333; border-radius:4px; line-height:1.4;">
    [SYSTEM READY] - Targeting Session Info for Location...
</div>

<div style="background:#1a1a1a; padding:15px; border:1px solid #333; color:#ff6600; font-family:Consolas, monospace; border-radius:4px;">
    <input type="text" id="pName" placeholder="RSI Handle" style="width:100%; margin-bottom:10px; background:#222; color:#fff; border:1px solid #444; padding:8px;">
    <input type="text" id="gCode" placeholder="Group Code (e.g. SQUAD1)" style="width:100%; margin-bottom:10px; background:#222; color:#fff; border:1px solid #444; padding:8px;">
    <input type="text" id="gUrl" placeholder="Google Script URL" style="width:100%; margin-bottom:15px; background:#222; color:#fff; border:1px solid #444; padding:8px;">
    
    <button id="finalStartBtn" style="width:100%; background:#ff6600; color:#000; font-weight:bold; padding:12px; border:none; cursor:pointer; font-family:Consolas, monospace; text-transform:uppercase;">
        START MONITORING
    </button>
</div>

<div id="squad-list-container" style="margin-top:20px; color:#ff6600; font-family:Consolas, monospace; background:#111; border:1px solid #333; padding:15px; display:none; border-radius:4px;">
    <h3 style="margin:0 0 15px 0; font-size:16px; border-bottom:1px solid #333; color:#00ffee; padding-bottom:5px;">ðŸ“¡ SQUAD STATUS (FILTERED)</h3>
    <table style="width:100%; border-collapse: collapse; text-align: left; color:#fff;">
        <thead>
            <tr style="font-size:12px; color:#888; text-transform:uppercase; border-bottom:1px solid #222;">
                <th style="padding:10px;">Handle</th>
                <th style="padding:10px;">Location</th>
                <th style="padding:10px;">Status</th>
            </tr>
        </thead>
        <tbody id="squad-table-body"></tbody>
    </table>
</div>

<video id="video" autoplay playsinline style="display:none;"></video>
<canvas id="monitor-canvas" style="display:none;"></canvas>

<script>
(function() {
    const tesseractScript = document.createElement('script');
    tesseractScript.src = "https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js";
    document.head.appendChild(tesseractScript);

    let lastStatus = "ALIVE";
    let lastLoc = "UNKNOWN";
    let respawnStartTime = 0;
    const COOLDOWN = 30000;

    function log(msg) {
        const d = document.getElementById('debug-log');
        if (d) { d.innerHTML += "<br>> " + msg; d.scrollTop = d.scrollHeight; }
    }

    tesseractScript.onload = () => {
        log("OCR Ready. Ensure r_DisplaySessionInfo 1 is active.");
        document.getElementById('finalStartBtn').addEventListener('click', init);
    };

    async function scanScreen() {
    const video = document.getElementById('video');
    const canvas = document.getElementById('monitor-canvas');
    if (!video || video.readyState !== 4) return;

    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    let currentStatus = "ALIVE";

    // 1. FAST PIXEL CHECK (Death)
    const frame = ctx.getImageData(canvas.width/2 - 10, canvas.height/2 - 10, 20, 20);
    let dark = 0;
    for (let i = 0; i < frame.data.length; i += 4) {
        if (frame.data[i] < 20 && frame.data[i+1] < 20 && frame.data[i+2] < 20) dark++;
    }

    if (dark > 350) {
        currentStatus = "RESPAWNING";
        respawnStartTime = Date.now();
    } else {
        // 2. INCAP OCR (Bottom Center)
        const incapC = document.createElement('canvas');
        incapC.width = 600; incapC.height = 150; // Magnified crop
        incapC.getContext('2d').drawImage(canvas, (canvas.width/2)-300, canvas.height*0.80, 600, 150, 0, 0, 600, 150);
        try {
            const { data: { text } } = await Tesseract.recognize(incapC, 'eng');
            if (text.toLowerCase().includes("incapacitated")) currentStatus = "INCAP";
        } catch(e) {}

        // 3. TARGETED & MAGNIFIED LOCATION SCAN (Top Right)
        const locW = 500; // Capture a 500px wide box
        const locH = 300; // Capture a 300px tall box
        const locC = document.createElement('canvas');
        locC.width = locW * 2; // Double the size for better OCR legibility
        locC.height = locH * 2;
        const lCtx = locC.getContext('2d');
        
        // Zoom in on the Session Info block
        lCtx.drawImage(canvas, canvas.width - locW, 0, locW, locH, 0, 0, locW * 2, locH * 2);

        // --- HIGH-CONTRAST NOISE GATE ---
        let imgData = lCtx.getImageData(0, 0, locC.width, locC.height);
        for (let i = 0; i < imgData.data.length; i += 4) {
            let avg = (imgData.data[i] + imgData.data[i+1] + imgData.data[i+2]) / 3;
            // Star Citizen info text is bright white (~200+). 
            // We kill everything else to make it "pop".
            let v = avg > 190 ? 255 : 0; 
            imgData.data[i] = imgData.data[i+1] = imgData.data[i+2] = v;
        }
        lCtx.putImageData(imgData, 0, 0);

        try {
            // Only scan every 8 seconds to save CPU, since location doesn't change fast
            if (ocrCounter % 2 === 0) {
                const { data: { text: zText } } = await Tesseract.recognize(locC, 'eng');
                // Regex looks for "Current player location :" OR "location :"
                const match = zText.match(/(?:location)\s*[:;]\s*([^(\n\r]+)/i);
                if(match) {
                    lastLoc = match[1].trim();
                    log("Verified Loc: " + lastLoc); 
                }
            }
        } catch(e) {}
    }

    if (currentStatus === "ALIVE" && (Date.now() - respawnStartTime < COOLDOWN)) {
        currentStatus = "RESPAWNING";
    }

    // Update Backend
    const gUrl = document.getElementById('gUrl').value;
    const pName = document.getElementById('pName').value;
    const gCode = document.getElementById('gCode').value.toUpperCase();
    
    if (gUrl && pName) {
        fetch(gUrl, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ player_name: pName, status: currentStatus, group_code: gCode, location: lastLoc })
        });
        if(currentStatus !== lastStatus) log("Syncing: " + currentStatus);
        lastStatus = currentStatus;
    }
}

    async function refreshSquad() {
        const gUrl = document.getElementById('gUrl').value;
        const gCode = document.getElementById('gCode').value.toUpperCase();
        if (!gUrl || !gCode) return;
        try {
            const res = await fetch(`${gUrl}?group=${gCode}`);
            const data = await res.json();
            const tbody = document.getElementById('squad-table-body');
            
            tbody.innerHTML = Object.entries(data).map(([n, val]) => {
                const parts = val.split('|');
                const st = parts[0].trim();
                const lc = parts[1] || "UNKNOWN";
                const color = st === 'INCAP' ? '#ff4444' : st === 'RESPAWNING' ? '#ffff00' : '#44ff44';
                return `<tr style="color:${color}; border-bottom:1px solid #222;">
                    <td style="padding:10px;">${n}</td>
                    <td style="padding:10px; color:#aaa; font-weight:normal;">${lc}</td>
                    <td style="padding:10px; font-weight:bold;">${st}</td>
                </tr>`;
            }).join('');
        } catch(e) {}
    }

    async function init() {
        try {
            const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            document.getElementById('video').srcObject = stream;
            document.getElementById('squad-list-container').style.display = "block";
            log("MONITORING ACTIVE.");
            setInterval(scanScreen, 4000);
            setInterval(refreshSquad, 4000);
            document.getElementById('finalStartBtn').disabled = true;
            document.getElementById('finalStartBtn').style.background = "#333";
        } catch (err) { log("Error: " + err.message); }
    }
})();
</script>
